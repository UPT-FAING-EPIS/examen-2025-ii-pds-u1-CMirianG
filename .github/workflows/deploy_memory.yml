name: Deploy In-Memory System

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Azure (In-Memory DB)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Clean and Restore
      run: |
        cd backend/AttendanceSystem.API
        dotnet clean
        dotnet restore

    - name: Build Application
      run: |
        cd backend/AttendanceSystem.API
        dotnet build --configuration Release --no-restore

    - name: Publish Application
      run: |
        cd backend/AttendanceSystem.API
        dotnet publish --configuration Release --no-build --output ./publish

    - name: Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'asistenciaestudiantil'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_API }}
        package: './backend/AttendanceSystem.API/publish'

    - name: Wait for deployment
      run: sleep 60

    - name: Test Health Check
      run: |
        echo "ðŸ” Probando health check..."
        for i in {1..5}; do
          if curl -f -s "http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net/health"; then
            echo "âœ… Health check exitoso!"
            break
          else
            echo "â³ Intento $i/5 - esperando..."
            sleep 30
          fi
        done

    - name: Test API Endpoints
      run: |
        echo "ðŸ” Probando endpoints de API..."
        
        # Test courses
        echo "ðŸ“š Probando /api/courses"
        curl -f "http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net/api/courses" || echo "âŒ Courses endpoint failed"
        
        # Test students
        echo "ðŸ‘¥ Probando /api/attendance/students"
        curl -f "http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net/api/attendance/students" || echo "âŒ Students endpoint failed"
        
        # Test sessions
        echo "ðŸ“… Probando /api/sessions"
        curl -f "http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net/api/sessions" || echo "âŒ Sessions endpoint failed"

    - name: Deployment Summary
      run: |
        echo "## ðŸŽ‰ Deployment Completado!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ URLs Disponibles:" >> $GITHUB_STEP_SUMMARY
        echo "- **API**: http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "- **Swagger**: http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net/swagger" >> $GITHUB_STEP_SUMMARY
        echo "- **Health**: http://asistenciaestudiantil-gefwbed2f7h8csd8.canadacentral-01.azurewebsites.net/health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… CaracterÃ­sticas:" >> $GITHUB_STEP_SUMMARY
        echo "- Base de datos en memoria (InMemoryDatabase)" >> $GITHUB_STEP_SUMMARY
        echo "- 2 cursos de ejemplo cargados" >> $GITHUB_STEP_SUMMARY
        echo "- 3 estudiantes de ejemplo" >> $GITHUB_STEP_SUMMARY
        echo "- 2 sesiones de ejemplo para hoy" >> $GITHUB_STEP_SUMMARY
        echo "- API REST completa funcionando" >> $GITHUB_STEP_SUMMARY
